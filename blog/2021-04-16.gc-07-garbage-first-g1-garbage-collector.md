[Garbage Collection Tuning](https://docs.oracle.com/en/java/javase/16/gctuning/introduction-garbage-collection-tuning.html)
===
[fdj32.github.io](https://fdj32.github.io)  
# 7. [垃圾优先垃圾收集器](https://docs.oracle.com/en/java/javase/16/gctuning/garbage-first-g1-garbage-collector1.html)
本章描述了垃圾优先垃圾收集器。
话题：
- <a href="#gc7a">垃圾优先垃圾收集器简介</a>
- <a href="#gc7b">启用G1</a>
- <a href="#gc7c">基本概念</a>
  - <a href="#gc7c1">堆布局</a>
  - <a href="#gc7c2">垃圾收集循环</a>
  - <a href="#gc7c3">垃圾收集暂停和收集集合</a>
- <a href="#gc7d">G1内部</a>
  - <a href="#gc7d1">决定初始化堆占用</a>
  - <a href="#gc7d2">标记</a>
  - <a href="#gc7d3">非常紧凑堆情况下的行为</a>
  - <a href="#gc7d4">决定初始化堆占用</a>
  - <a href="#gc7d5">巨大对象</a>
  - <a href="#gc7d6">仅年轻代容量</a>
  - <a href="#gc7d7">空间回收阶段代容量</a>
- <a href="#gc7e">垃圾优先垃圾收集器人机默认值</a>
- <a href="#gc7f">与其他收集器比较</a>

## <span id="gc7a">垃圾优先垃圾收集器简介</span>
G1垃圾收集器是为多处理器大量内存设计的。它尝试以高概率达到垃圾收集暂停时间目标，同时无需多少配置达到高吞吐量目标。G1的目的是提供时延与吞吐量的最佳平衡点，使用具有以下特性的当前目标应用和环境。
- 堆内存达到数十GB或更多，且超过50%的Java堆被活动数据占据。
- 对象分配和升级的速率会随着时间的推移而显著变化。
- 堆内有大量碎片
- 可预见的暂停时间目标短于几百毫秒，避免垃圾收集长时间暂停。

G1在应用运行的同时也进行一部分工作。它交换应用程序可以使用的处理器资源，以缩短收集暂停时间。

这在应用程序运行时使用一个或多个活动的垃圾收集线程时最为明显。因此，与吞吐量收集器相比，虽然G1收集器的垃圾收集暂停时间通常要短得多，但应用程序吞吐量也往往略低。

G1是默认收集器。

G1收集器实现了高性能，并尝试通过以下几节中描述的几种方式来实现暂停时间目标。
## <span id="gc7b">启用G1</span>
垃圾第一垃圾收集器是默认的收集器，因此通常不必执行任何其他操作。您可以通过在命令行上提供-XX:+UseG1GC显式地启用它。
## <span id="gc7c">基本概念</span>
G1是一个分代的、增量的、并行的、主要是并发的、停止世界和疏散垃圾收集器，它监视每个停止世界暂停中的暂停时间目标。与其他收集器类似，G1将堆拆分为（虚拟的）年轻代和老年代。空间回收工作主要集中在年轻一代，在年轻一代中，这样做是最有效的，偶尔在老一代的空间回收。

一些操作总是在stop-the-world暂停中执行，以提高吞吐量。在应用程序停止时需要更多时间的其他操作（如全局标记等整个堆操作）与应用程序并行执行。为了使stop-the-world暂停时间短于空间回收时间，G1会逐步并行地执行空间回收。G1通过跟踪有关以前的应用程序行为和垃圾收集暂停的信息来构建相关成本的模型，从而实现可预测性。它使用这些信息来调整暂停中完成的工作的大小。例如，G1首先回收效率最高的区域中的空间（即大部分被垃圾填满的区域，因此命名为G1）。

G1主要通过疏散来回收空间：在选定的要收集的内存区域中找到的活动对象被复制到新的内存区域，并在这个过程中压缩它们。疏散完成后，先前由活动对象占用的空间将被应用程序重新分配。

垃圾第一收集器不是实时收集器。它试图在较长的时间内以高概率满足设定的暂停时间目标，但对于给定的暂停时间并不总是绝对确定的。
### <span id="gc7c1">堆布局</span>
G1将堆划分为一组大小相等的堆区域，每个区域都是虚拟内存的连续范围，如图9-1所示。区域是内存分配和内存回收的单位。在任何给定的时间，这些区域中的每一个都可以是空的（浅灰色），或者分配给特定的一代，年轻的或年老的。当内存请求传入时，内存管理器将释放可用区域。内存管理器将它们分配给一个年龄代，然后将它们作为空闲空间返回给应用程序，应用程序可以将自己分配到其中。

图 7-1 G1垃圾收集器堆布局

![Figure 7-1 G1 Garbage Collector Heap Layout](https://docs.oracle.com/en/java/javase/16/gctuning/img/jsgct_dt_004_grbg_frst_hp.png "Description of Figure 7-1 follows")

<a href="https://docs.oracle.com/en/java/javase/16/gctuning/img_text/jsgct_dt_004_grbg_frst_hp.html">图表描述</a>

年轻一代包含初生代（红色）和幸存者区域（红色带“S”）。这些区域提供了与其他收集器中相应的相邻空间相同的功能，不同的是，在G1中，这些区域通常以非连续模式在内存中布局。老地区（浅蓝色）组成了老年代。对于跨越多个区域的对象，老年代可能是巨大的（浅蓝色带“H”）。

一个应用程序总是分配到年轻代，也就是初生代，除了庞大的对象是直接分配为属于老年代。
### <span id="gc7c2">垃圾收集周期</span>
在高水平上，G1收集器在两个阶段之间交替。仅年轻阶段包含垃圾收集，这些垃圾收集会逐渐用老年代中的对象填充当前可用的内存。在空间回收阶段，G1除了处理年轻代之外，还会逐步回收老年代的空间。然后，循环以一个仅年轻阶段重新开始。

图7-2给出了有关此循环的概述，并举例说明了可能发生的垃圾收集暂停序列：

图 7-2 垃圾收集循环概述

![Figure 7-2 Garbage Collection Cycle Overview ](https://docs.oracle.com/en/java/javase/16/gctuning/img/jsgct_dt_001_grbgcltncyl.png "Description of Figure 7-2 follows")

<a href="https://docs.oracle.com/en/java/javase/16/gctuning/img_text/jsgct_dt_001_grbgcltncyl.html">图表描述</a>

以下列表详细描述了G1垃圾收集周期的阶段、暂停和阶段间的转换：
1. 仅年轻阶段：这个阶段从几个普通的年轻代收集开始，这些收集将对象提升到老年代。当老年代占用达到一定阈值时，即初始堆占用阈值，则开始仅年轻阶段与空间回收阶段之间的转换。此时，G1计划并发启动年轻收集，而不是常规的年轻收集。
- 并发开始：这种类型的收集除了执行正常的年轻代收集外，还启动标记过程。并发标记确定老年代区域中的所有当前可到达（活动）对象将保留用于以下空间回收阶段。当收集标记尚未完全完成时，可能会发生正常的年轻代收集。标记结束时有两个特别的停止世界暂停：标记和清理。
- 备注：此暂停完成标记本身，执行全局引用处理和类卸载，回收完全空的区域并清理内部数据结构。在Remark和Cleanup之间G1计算信息，以便以后能够同时回收选定老年代区域中的可用空间，这将在Cleanup 暂停中完成。
- 清理：此暂停决定是否将实际执行空间回收阶段。如果接下来是空间回收阶段，则仅年轻阶段将以单个Prepare Mixed 年轻代收集完成。
2. 空间回收阶段：这个阶段由多个混合收集组成，除了年轻代区域外，还可以疏散老年代区域集合中的活动对象。G1确定疏散更多的老年代区域，不会产生足够的自由空间，不值得为此花费努力，空间回收阶段就结束了。

在空间回收之后，收集周期将以另一个仅年轻阶段重新开始。作为备份，如果应用程序在收集活动信息时内存不足，G1会像其他收集器一样执行就地停止世界完全堆压缩（fullgc）。
### <span id="gc7c3">垃圾收集暂停和收集集合</span>
G1在停止世界暂停中执行垃圾收集和空间回收。活动对象通常从源区域复制到堆中的一个或多个目标区域，并调整对这些移动对象的现有引用。

对于非大型区域，对象的目标区域由该对象的源区域确定：
- 年轻代的对象（初生代和幸存者区）被复制到幸存者区或老年代区，这取决于他们的年龄。
- 老年代区的对象被复制到其他老年代区。

巨型区的对象被区别对待。G1只查看了它们的活跃度，如果它们不活跃，就收回它们所占据的空间。巨型区内的对象永远不会被G1移动。

收集集是要从中回收空间的源区域集合。根据垃圾收集的类型，收集集由不同类型的区域组成：
- 在仅年轻阶段，收集集仅由年轻代中的区域和具有潜在回收对象的巨型区组成。
- 在空间回收阶段，收集集由年轻代的区域、具有潜在回收对象的巨型区和收集集候选区域集中的一些老年代区域组成。

G1在并发循环期间准备收集集候选区域。在备注暂停期间，G1选择占用率较低的区域，这些区域包含大量可用空间。然后，在备注和清除暂停之间同时准备这些区域，以便以后收集。清理暂停根据其效率对该准备的结果进行排序。在随后的混合收集中，更有效的区域似乎需要更少的时间来收集，并且包含更多的可用空间。
## <span id="gc7d">G1内部</span>
本节介绍垃圾优先（G1）垃圾收集器的一些重要细节。
### <span id="gc7d1">决定初始化堆占用</span>

### <span id="gc7d2">标记</span>
### <span id="gc7d3">非常紧凑堆情况下的行为</span>
### <span id="gc7d4">决定初始化堆占用</span>
### <span id="gc7d5">巨大对象</span>
### <span id="gc7d6">仅年轻代容量</span>
### <span id="gc7d7">空间回收阶段代容量</span>
## <span id="gc7e">垃圾优先垃圾收集器人机默认值</span>
## <span id="gc7f">与其他收集器比较</span>
